<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fall 2025 Lab Availability</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background: #0f172a; color: #e6eef8; }
</style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">
  <header class="w-full max-w-3xl">
    <h1 class="text-3xl font-bold mb-0 text-center">Fall 2025 Lab Availability</h1>
    <p class="text-center text-slate-300 mb-4">BRAC University ‚Äî Dhaka, Bangladesh</p>
    <div id="status" class="text-center text-slate-400 mb-6">Loading data...</div>
  </header>

  <!-- Live time + controls -->
  <div class="w-full max-w-3xl grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 bg-slate-800 rounded-lg text-center">
      <div class="text-sm text-slate-400">Current Local Time</div>
      <div id="localTime" class="font-mono text-xl font-semibold mt-1"></div>
    </div>

    <div class="p-4 bg-slate-800 rounded-lg">
      <label class="block text-sm text-slate-300 mb-1 font-medium">Select Lab Room</label>
      <select id="labSelect" class="w-full p-2 rounded text-slate-900">
        <option value="">-- All Rooms --</option>
      </select>
    </div>

    <div class="p-4 bg-slate-800 rounded-lg">
      <div class="text-sm text-slate-300 mb-1 font-medium">Results</div>
      <div id="summary" class="text-slate-300">Showing available rooms for current time</div>
    </div>
  </div>

  <!-- üõ† Find lab/room in another time -->
  <section class="w-full max-w-3xl mb-6 p-4 bg-slate-800 rounded-lg">
    <h2 class="text-lg font-semibold mb-2">üõ† Find lab/room in another time</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="block text-sm text-slate-300 mb-1">Day</label>
        <select id="testDay" class="w-full p-2 rounded text-slate-900">
          <option value="">Use current day</option>
          <option value="SUN">SUN</option>
          <option value="MON">MON</option>
          <option value="TUE">TUE</option>
          <option value="WED">WED</option>
          <option value="THU">THU</option>
          <option value="FRI">FRI</option>
          <option value="SAT">SAT</option>
        </select>
      </div>

      <div>
        <label class="block text-sm text-slate-300 mb-1">Time</label>
        <input id="testTime" type="time" class="w-full p-2 rounded text-slate-900" />
      </div>

      <div class="flex items-end">
        <button id="applyTest" class="w-full py-2 px-3 rounded bg-indigo-600 hover:bg-indigo-500">Apply</button>
      </div>
    </div>

    <p class="text-sm text-slate-400 mt-3">
      Pick a day & time to see which lab rooms are <strong>available (empty)</strong> at that moment.
    </p>
  </section>

  <!-- Results card -->
  <main class="w-full max-w-3xl">
    <div id="statusCard" class="w-full p-6 rounded-xl shadow-lg bg-gradient-to-r from-slate-800 to-slate-900">
      <p class="text-lg text-slate-300">Loading availability...</p>
    </div>
  </main>

  <script>
    let labsData = [];
    const statusElem = document.getElementById('status');
    const statusCard = document.getElementById('statusCard');
    const labSelect = document.getElementById('labSelect');
    const summaryElem = document.getElementById('summary');

    // Update local time
    function updateLocalTime() {
      const now = new Date();
      document.getElementById('localTime').textContent =
        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    setInterval(updateLocalTime, 1000);
    updateLocalTime();

    // Convert "8:00 AM" ‚Üí minutes
    function timeToMinutes(timeStr) {
      if (!timeStr) return NaN;
      const [time, meridian] = timeStr.trim().split(' ');
      let [h, m] = time.split(':').map(Number);
      if (meridian?.toUpperCase() === 'PM' && h !== 12) h += 12;
      if (meridian?.toUpperCase() === 'AM' && h === 12) h = 0;
      return h * 60 + m;
    }

    function calculateAvailability(targetDay, targetMinutes) {
      const rooms = [...new Set(labsData.map(x => x.labRoom).filter(Boolean))].sort();
      const occupiedMap = {};
      const upcomingMap = {};

      rooms.forEach(room => {
        const entries = labsData.filter(e => e.labRoom === room);
        const occupying = entries.find(e => {
          const start = timeToMinutes(e.labTime);
          const end = start + 180;
          return e.labDay === targetDay && targetMinutes >= start && targetMinutes < end;
        });
        occupiedMap[room] = occupying || null;

        const upcoming = entries
          .filter(e => e.labDay === targetDay && timeToMinutes(e.labTime) > targetMinutes)
          .sort((a,b) => timeToMinutes(a.labTime) - timeToMinutes(b.labTime))[0];
        if (upcoming) upcomingMap[room] = upcoming;
      });

      const availableRooms = rooms.filter(r => !occupiedMap[r]);
      return { rooms, occupiedMap, availableRooms, upcomingMap };
    }

    function renderAvailability(targetDay, targetMinutes) {
      const { rooms, occupiedMap, availableRooms, upcomingMap } = calculateAvailability(targetDay, targetMinutes);
      const selectedRoom = labSelect.value;

      if (selectedRoom) {
        const occ = occupiedMap[selectedRoom];
        if (occ) {
          statusCard.innerHTML = `
            <p class="text-2xl font-bold text-red-400 mb-2">Occupied ‚Äî ${selectedRoom}</p>
            <div class="text-left">
              <p><strong>Course:</strong> ${occ.course}</p>
              <p><strong>Faculty:</strong> ${occ.labFaculty}</p>
              <p><strong>Time:</strong> ${occ.labTime} (${occ.labDay})</p>
            </div>`;
          summaryElem.textContent = `${selectedRoom} is occupied at selected time.`;
        } else {
          const next = upcomingMap[selectedRoom];
          statusCard.innerHTML = `
            <p class="text-2xl font-bold text-green-400 mb-2">Available ‚Äî ${selectedRoom}</p>
            <div class="text-left">
              <p class="text-slate-300 mb-1">This room has no lab at the chosen time.</p>
              ${next ? `<p><strong>Next on ${targetDay}:</strong> ${next.course} at ${next.labTime}</p>` : `<p class="text-slate-400">No more labs scheduled for ${targetDay}.</p>`}
            </div>`;
          summaryElem.textContent = `${selectedRoom} is available at selected time.`;
        }
        return;
      }

      if (availableRooms.length > 0) {
        summaryElem.textContent = `Showing ${availableRooms.length} empty room(s) for ${targetDay} at ${formatMinutes(targetMinutes)}.`;
        let html = `<p class="text-2xl font-bold text-green-400 mb-2">üü¢ Available Lab Rooms (${availableRooms.length})</p>`;
        availableRooms.forEach(r => {
          const next = upcomingMap[r];
          html += `
            <div class="border border-green-600 rounded-lg p-3 mb-3 bg-slate-900">
              <p class="font-semibold">${r}</p>
              <p class="text-sm text-slate-300 mt-1">${ next ? `Next: ${next.course} at ${next.labTime}` : 'No more labs today' }</p>
            </div>`;
        });
        statusCard.innerHTML = html;
      } else {
        summaryElem.textContent = `No lab room is empty for ${targetDay} at ${formatMinutes(targetMinutes)}.`;
        statusCard.innerHTML = `
          <p class="text-2xl font-bold text-red-400 mb-2">üî¥ No lab room is empty right now</p>
          <p class="text-lg text-slate-300">All rooms have a scheduled lab at the selected time.</p>`;
      }
    }

    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      const hh = ((h + 11) % 12) + 1;
      const ampm = h >= 12 ? 'PM' : 'AM';
      return `${hh}:${String(m).padStart(2,'0')} ${ampm}`;
    }

    function checkAndRender() {
      const now = new Date();
      const days = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
      const testDay = document.getElementById('testDay').value;
      const testTime = document.getElementById('testTime').value;

      const targetDay = testDay || days[now.getDay()];
      const targetMinutes = testTime ? (() => {
        const [hh, mm] = testTime.split(':').map(Number);
        return hh * 60 + mm;
      })() : now.getHours() * 60 + now.getMinutes();

      renderAvailability(targetDay, targetMinutes);
    }

    fetch('Fall25_lab_availibility.json')
      .then(r => r.json())
      .then(data => {
        labsData = (data.Sheet2 || []).map(it => ({
          course: (it[" COURSE"] || '').trim(),
          labFaculty: (it["LAB FACULTY"] || '').trim(),
          labDay: (it["DAY_1"] || '').trim(),
          labTime: (it["TIME_1"] || '').trim(),
          labRoom: (it["LAB"] || '').trim(),
        })).filter(x => x.labRoom);

        statusElem.textContent = `Loaded ${labsData.length} lab entries for Fall 2025.`;

        const rooms = [...new Set(labsData.map(x => x.labRoom))].sort();
        rooms.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.textContent = r;
          labSelect.appendChild(opt);
        });

        document.getElementById('applyTest').addEventListener('click', () => {
          labSelect.value = '';
          checkAndRender();
        });
        labSelect.addEventListener('change', checkAndRender);
        document.getElementById('testDay').addEventListener('change', () => { labSelect.value = ''; checkAndRender(); });
        document.getElementById('testTime').addEventListener('input', () => { labSelect.value = ''; checkAndRender(); });

        checkAndRender();
        setInterval(() => {
          if (!document.getElementById('testTime').value && !document.getElementById('testDay').value) {
            checkAndRender();
          }
        }, 30000);
      })
      .catch(err => {
        console.error('Error loading JSON', err);
        statusElem.textContent = 'Failed to load lab data.';
        statusCard.innerHTML = `<p class="text-red-400">Failed to load lab data.</p>`;
      });
  </script>
</body>
  <!-- Footer -->
  <footer class="mt-12 py-6 w-full text-center border-t border-slate-700 text-gray-400">
    <p class="text-sm">
      Made with ‚ù§Ô∏è by 
      <a href="https://github.com/TahmidRaven" target="_blank" class="text-blue-400 hover:text-blue-300 font-medium">Raven</a> 
      ‚Ä¢ 
      <a href="https://tahmidraven.online" target="_blank" class="text-blue-400 hover:text-blue-300 font-medium">tahmidraven.online</a>
    </p>
    <p class="text-xs mt-1">
      ¬© 2025 BRAC University ‚Äî Lab Availability Project
    </p>
  </footer>

</html>
